[gd_scene load_steps=21 format=3 uid="uid://dslrcpn3uvfpk"]

[ext_resource type="Texture2D" uid="uid://qwape8mdcn7b" path="res://assets/tile/land_0.png" id="1_tevcd"]
[ext_resource type="Texture2D" uid="uid://d25mb520n1jy1" path="res://assets/tile/wall_0.png" id="2_r6o8j"]
[ext_resource type="Texture2D" uid="uid://b2wthb0laugtr" path="res://assets/tile/land_1.png" id="3_8lqlh"]
[ext_resource type="Texture2D" uid="uid://ci036cnv2iu5o" path="res://assets/tile/wall_1.png" id="4_tf1q3"]
[ext_resource type="Texture2D" uid="uid://can0k8vmi2yao" path="res://assets/tile/pre_choose.png" id="5_0n7kj"]
[ext_resource type="AudioStream" uid="uid://bafyvcn6gb683" path="res://assets/sound/excavate_soil.mp3" id="5_2orfh"]
[ext_resource type="PackedScene" uid="uid://bl2i8l7gpowjf" path="res://source/object/character.tscn" id="5_vclm3"]
[ext_resource type="Texture2D" uid="uid://djgr7e25ayqc7" path="res://assets/particle/nomal.png" id="6_bohh8"]
[ext_resource type="PackedScene" uid="uid://ci4ey1lmw7h8f" path="res://interface/ui_inventory.tscn" id="6_mby8f"]

[sub_resource type="GDScript" id="GDScript_sxsmm"]
script/source = "
extends Node

@onready var tilemap = $TileMap
@onready var player = $Character

func _process(delta):
	tilemap.player_pos = player.position
"

[sub_resource type="Environment" id="Environment_ulcol"]
background_mode = 3
ambient_light_color = Color(1, 1, 1, 1)
glow_enabled = true
glow_intensity = 0.3
glow_blend_mode = 0
glow_hdr_threshold = 0.66
glow_hdr_scale = 1.2
glow_hdr_luminance_cap = 6.0

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_5j2ki"]
texture = ExtResource("1_tevcd")
texture_region_size = Vector2i(18, 18)
0:0/0 = 0
0:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:0/0/physics_layer_0/angular_velocity = 0.0

[sub_resource type="OccluderPolygon2D" id="OccluderPolygon2D_46no7"]
polygon = PackedVector2Array(-8, -8, 8, -8, 8, 8, -8, 8)

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_rbev1"]
texture = ExtResource("2_r6o8j")
texture_region_size = Vector2i(18, 31)
0:0/0 = 0
0:0/0/texture_origin = Vector2i(0, 8)
0:0/0/z_index = 2
0:0/0/occlusion_layer_0/polygon = SubResource("OccluderPolygon2D_46no7")
0:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:0/0/physics_layer_0/angular_velocity = 0.0
0:0/0/physics_layer_0/polygon_0/points = PackedVector2Array(-8, -8, 8, -8, 8, 8, -8, 8)
0:1/0 = 0
0:1/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:1/0/physics_layer_0/angular_velocity = 0.0
0:2/0 = 0
0:2/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:2/0/physics_layer_0/angular_velocity = 0.0

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_f3cwc"]
texture = ExtResource("3_8lqlh")
texture_region_size = Vector2i(16, 80)
0:2/0 = 0
0:2/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:2/0/physics_layer_0/angular_velocity = 0.0
0:0/0 = 0
0:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:0/0/physics_layer_0/angular_velocity = 0.0

[sub_resource type="OccluderPolygon2D" id="OccluderPolygon2D_48xy1"]
polygon = PackedVector2Array(-8, -24, 8, -24, 8, 8, -8, 8)

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_oxroa"]
texture = ExtResource("4_tf1q3")
texture_region_size = Vector2i(16, 80)
0:0/0 = 0
0:0/0/z_index = 2
0:0/0/occlusion_layer_0/polygon = SubResource("OccluderPolygon2D_48xy1")
0:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:0/0/physics_layer_0/angular_velocity = 0.0
0:0/0/physics_layer_0/polygon_0/points = PackedVector2Array(-8, -8, 8, -8, 8, 8, -8, 8)
0:1/0 = 0
0:1/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:1/0/physics_layer_0/angular_velocity = 0.0
0:2/0 = 0
0:2/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:2/0/physics_layer_0/angular_velocity = 0.0

[sub_resource type="TileSet" id="TileSet_lpjw5"]
occlusion_layer_0/light_mask = 1
physics_layer_0/collision_layer = 1
sources/0 = SubResource("TileSetAtlasSource_5j2ki")
sources/1 = SubResource("TileSetAtlasSource_rbev1")
sources/2 = SubResource("TileSetAtlasSource_f3cwc")
sources/3 = SubResource("TileSetAtlasSource_oxroa")

[sub_resource type="GDScript" id="GDScript_n8457"]
script/source = "
extends TileMap

@onready var pre_choose = $PreChoose

@onready var excavate_soil_sound = $ExcavateSoil

@onready var excavate_particles = $ExcavateParticles

var border = 1024
var safe_zone = 9 # 出生点保护

var zone_0 = 64 # 泥土圈
var zone_1 = 128 # 石头圈

var cave_noise = FastNoiseLite.new()

var player_pos = Vector2.ZERO

func _ready():
	cave_noise.seed = randi()
	cave_noise.frequency = 0.03
	cave_noise.fractal_octaves = 3
	
	for x in range(-border/2,border/2):
		for y in range(-border/2,border/2):
			
			# 石头圈
			if -zone_1 <= x and x <= zone_1:
				if -zone_1 <= y and y <= zone_1:
					if cave_noise.get_noise_2d(x, y)*45 >= -16:
						set_cell(3,Vector2(x, y),3,Vector2(0,0),0)
				
					set_cell(0,Vector2(x, y),2,Vector2(0,0),0)
			# 泥土圈
			if -zone_0 <= x and x <= zone_0:
				if -zone_0 <= y and y <= zone_0:
					if cave_noise.get_noise_2d(x, y)*45 >= -16:
						set_cell(3,Vector2(x, y),1,Vector2(0,0),0)
				
					set_cell(0,Vector2(x, y),0,Vector2(0,0),0)
	# 出生点保护
	for x in range(-safe_zone/2,safe_zone/2):
		for y in range(-safe_zone/2,safe_zone/2):
				set_cell(3,Vector2(x, y),-1,Vector2(0,0),0)
	
func _process(delta):
	var player_position = player_pos
	var mouse_position = get_global_mouse_position()
	
	var angle = rad_to_deg(atan2(mouse_position.y - player_position.y
								, mouse_position.x - player_position.x))+180
	var player = local_to_map(player_pos)
	
	# 上
	if 44 <= angle and angle <= 135:
		pre_choose.position = map_to_local(Vector2(player.x, player.y-1))
	# 右
	if 134 <= angle and angle <= 255:
		pre_choose.position = map_to_local(Vector2(player.x+1, player.y))
	# 下
	if 254 <= angle and angle <= 345:
		pre_choose.position = map_to_local(Vector2(player.x, player.y+1))
	# 左
	if angle <= 45 or angle >= 344:
		pre_choose.position = map_to_local(Vector2(player.x-1, player.y))
	
func _input(event):
	if event is InputEventMouseButton:
		if event.button_index == MOUSE_BUTTON_LEFT and event.pressed:
			var player_position = player_pos
			var mouse_position = get_global_mouse_position()
			
			var angle = rad_to_deg(atan2(mouse_position.y - player_position.y
										, mouse_position.x - player_position.x))+180
			var player = local_to_map(player_pos)
			
			# 上
			if 44 <= angle and angle <= 135:
				if get_cell_source_id(3,Vector2(player.x, player.y-1),false) != -1:
					excavate_effect(map_to_local(Vector2(player.x, player.y-1)))
					set_cell(3,Vector2(player.x, player.y-1),-1,Vector2(0,0),0)
			# 右
			if 134 <= angle and angle <= 255:
				if get_cell_source_id(3,Vector2(player.x+1, player.y),false) != -1:
					excavate_effect(map_to_local(Vector2(player.x+1, player.y)))
					set_cell(3,Vector2(player.x+1, player.y),-1,Vector2(0,0),0)
			# 下
			if 254 <= angle and angle <= 345:
				if get_cell_source_id(3,Vector2(player.x, player.y+1),false) != -1:
					excavate_effect(map_to_local(Vector2(player.x, player.y+1)))
					set_cell(3,Vector2(player.x, player.y+1),-1,Vector2(0,0),0)
			# 左
			if angle <= 45 or angle >= 344:
				if get_cell_source_id(3,Vector2(player.x-1, player.y),false) != -1:
					excavate_effect(map_to_local(Vector2(player.x-1, player.y)))
					set_cell(3,Vector2(player.x-1, player.y),-1,Vector2(0,0),0)
			
func excavate_effect(pos):
	excavate_soil_sound.position = pos
	excavate_soil_sound.play()
	excavate_particles.position = Vector2(pos.x,pos.y+1)
	excavate_particles.emitting = true
"

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_0hudt"]
particle_flag_disable_z = true
emission_shape = 3
emission_box_extents = Vector3(1, 1, 1)
angle_max = 720.0
radial_velocity_max = 16.0
gravity = Vector3(0, 0, 0)
linear_accel_max = 100.0
scale_min = 0.1
scale_max = 3.0

[node name="GameMain" type="Node2D"]
y_sort_enabled = true
texture_filter = 1
script = SubResource("GDScript_sxsmm")

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_ulcol")

[node name="CanvasModulate" type="CanvasModulate" parent="."]
color = Color(0, 0, 0, 1)

[node name="TileMap" type="TileMap" parent="."]
y_sort_enabled = true
texture_filter = 1
tile_set = SubResource("TileSet_lpjw5")
format = 2
layer_0/name = "Land"
layer_1/name = "Floor"
layer_1/z_index = 1
layer_1/tile_data = PackedInt32Array()
layer_2/name = "Decorate"
layer_2/y_sort_enabled = true
layer_2/z_index = 2
layer_2/tile_data = PackedInt32Array()
layer_3/name = "Wall"
layer_3/y_sort_enabled = true
layer_3/z_index = 2
layer_3/tile_data = PackedInt32Array()
script = SubResource("GDScript_n8457")

[node name="PreChoose" type="Sprite2D" parent="TileMap"]
modulate = Color(1, 1, 1, 0.392157)
z_index = 9
texture_filter = 1
texture = ExtResource("5_0n7kj")

[node name="ExcavateParticles" type="GPUParticles2D" parent="TileMap"]
modulate = Color(1, 1, 1, 0.392157)
z_index = 4
y_sort_enabled = true
texture_filter = 1
emitting = false
amount = 16
process_material = SubResource("ParticleProcessMaterial_0hudt")
texture = ExtResource("6_bohh8")
lifetime = 0.6
one_shot = true
speed_scale = 2.0
fixed_fps = 60

[node name="ExcavateSoil" type="AudioStreamPlayer2D" parent="TileMap"]
stream = ExtResource("5_2orfh")
bus = &"VFX"

[node name="Character" parent="." instance=ExtResource("5_vclm3")]

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="Inventory" parent="CanvasLayer" instance=ExtResource("6_mby8f")]
